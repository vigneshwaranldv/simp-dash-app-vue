<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Config-Driven Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Vue 3 + Vuetify CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.5.0/dist/vuetify.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.5.0/dist/vuetify.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.3.67/css/materialdesignicons.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Roboto, sans-serif; margin: 0; padding: 0; }
    .dashboard-section { margin-bottom: 2rem; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    const { createApp, ref, onMounted, computed } = Vue;
    const { createVuetify } = Vuetify;
    const vuetify = createVuetify();

    const app = createApp({
      setup() {
        const sections = ref([]);
        const userInput = ref("");
        const loading = ref(false);
        const error = ref(null);
        const activeTab = ref(0);

        const inlineSections = computed(() => sections.value.filter(s => !s.useTab));
        const tabbedSections = computed(() => sections.value.filter(s => s.useTab));

        async function loadConfig() {
          const urlParams = new URLSearchParams(window.location.search);
          const configName = urlParams.get("page") || "default";
          const configPath = `./configs/${configName}.json`;

          try {
            const res = await fetch(configPath);
            const config = await res.json();
            sections.value = config.sections || [];

            for (const section of sections.value) {
              if (!section.allowInput) {
                await fetchData(section);
              }
            }
          } catch (err) {
            error.value = `Failed to load config: ${err.message}`;
          }
        }

        async function fetchData(section, input) {
          loading.value = true;
          const payload = section.payload || {};
          if (input) payload.input = input;

          try {
            let response;
            if (section.apiType === "POST") {
              response = await fetch(section.api, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
            } else {
              response = await fetch(section.api);
            }
            section._data = await response.json();
          } catch (err) {
            section._data = [];
            console.error('API fetch failed:', err);
          } finally {
            loading.value = false;
          }
        }

        onMounted(loadConfig);

        return { sections, inlineSections, tabbedSections, fetchData, userInput, loading, error, activeTab };
      },
      template: `
        <v-app>
          <v-container>
            <v-alert type="error" v-if="error">{{ error }}</v-alert>
            <v-progress-linear v-if="loading" indeterminate color="primary"></v-progress-linear>

            <div v-for="(section, idx) in inlineSections" :key="'inline-' + idx" class="dashboard-section">
              <h3>{{ section.title }}</h3>

              <div v-if="section.allowInput">
                <v-text-field v-model="userInput" :label="section.inputLabel || 'Enter Value'"></v-text-field>
                <v-btn @click="section._data = null" color="secondary">Clear</v-btn>
                <v-btn @click="fetchData(section, userInput)" color="primary">Submit</v-btn>
              </div>

              <v-card v-if="section.type === 'card' && section._data" class="pa-4 my-4">
                <div v-for="(value, key) in section._data" :key="key">
                  <strong>{{ key }}:</strong> {{ value }}
                </div>
              </v-card>

              <v-data-table
                v-if="section.type === 'table' && section._data"
                :headers="section.headers || Object.keys(section._data[0] || {}).map(k => ({ title: k, key: k }))"
                :items="section._data"
                class="elevation-1 mt-4"
              />

              <canvas
                v-if="section.type === 'chart' && section._data"
                :id="'chart-inline-' + idx"
                width="400" height="200"
                class="mt-4"
              ></canvas>
            </div>

            <div v-if="tabbedSections.length">
              <v-tabs v-model="activeTab" class="my-4">
                <v-tab v-for="(section, idx) in tabbedSections" :key="'tab-' + idx">
                  {{ section.title }}
                </v-tab>
              </v-tabs>

              <v-window v-model="activeTab">
                <v-window-item v-for="(section, idx) in tabbedSections" :key="'tab-view-' + idx" :value="idx">
                  <div class="dashboard-section">
                    <h3>{{ section.title }}</h3>

                    <div v-if="section.allowInput">
                      <v-text-field v-model="userInput" :label="section.inputLabel || 'Enter Value'"></v-text-field>
                      <v-btn @click="section._data = null" color="secondary">Clear</v-btn>
                      <v-btn @click="fetchData(section, userInput)" color="primary">Submit</v-btn>
                    </div>

                    <v-card v-if="section.type === 'card' && section._data" class="pa-4 my-4">
                      <div v-for="(value, key) in section._data" :key="key">
                        <strong>{{ key }}:</strong> {{ value }}
                      </div>
                    </v-card>

                    <v-data-table
                      v-if="section.type === 'table' && section._data"
                      :headers="section.headers || Object.keys(section._data[0] || {}).map(k => ({ title: k, key: k }))"
                      :items="section._data"
                      class="elevation-1 mt-4"
                    />

                    <canvas
                      v-if="section.type === 'chart' && section._data"
                      :id="'chart-tab-' + idx"
                      width="400" height="200"
                      class="mt-4"
                    ></canvas>
                  </div>
                </v-window-item>
              </v-window>
            </div>
          </v-container>
        </v-app>
      `,
      updated() {
        const renderCharts = (sectionList, prefix) => {
          sectionList.forEach((section, idx) => {
            if (section.type === 'chart' && section._data) {
              const chartId = `chart-${prefix}-${idx}`;
              const ctx = document.getElementById(chartId);
              if (ctx && !ctx.dataset.rendered) {
                new Chart(ctx, {
                  type: section.chartType || 'bar',
                  data: {
                    labels: section._data.map(item => item.label || item.title || item.id),
                    datasets: [{
                      label: section.chartLabel || 'Dataset',
                      data: section._data.map(item => item.value || item.id),
                      backgroundColor: 'rgba(54, 162, 235, 0.5)'
                    }]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false
                  }
                });
                ctx.dataset.rendered = true;
              }
            }
          });
        };

        renderCharts(this.inlineSections, 'inline');
        renderCharts(this.tabbedSections, 'tab');
      }
    });

    app.use(vuetify).mount('#app');
  </script>
</body>
</html>
