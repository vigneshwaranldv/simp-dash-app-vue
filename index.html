<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dynamic Table (ES-module)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Vuetify CSS -->
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.5.0/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.3.67/css/materialdesignicons.min.css" rel="stylesheet">

    <!-- Import-map tells the browser where to find “vue” and “vuetify” -->
    <script type="importmap">
  {
    "imports": {
      "vue":     "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
      "vuetify": "https://cdn.jsdelivr.net/npm/vuetify@3.5.0/dist/vuetify.esm.js"
    }
  }
  </script>
</head>

<body style="margin:0">
    <div id="app"></div>

    <!-- main script (index.html) -->
    <script type="module">
        import { createApp, ref, onMounted, watch } from 'vue';
        import { createVuetify, useTheme } from 'vuetify';
        import DynamicTable from './dynamic-table.js';
        import DynamicCard from './dynamic-card.js';

        /* ---------- Vuetify instance with light & dark ---------- */
        const vuetify = createVuetify({
            theme: {
                defaultTheme: 'dark',
                themes: {
                    light: { dark: false },
                    dark: { dark: true }
                }
            }
        });

        /* ---------- Root component ---------- */
        const App = {
            components: { DynamicTable, DynamicCard },

            setup() {
                /* datasets that come from the config */
                const datasets = ref([]);

                /* ---- dark / light toggle ---- */
                const vTheme = useTheme();
                const isDark = ref(true);

                watch(isDark, val => {
                    vTheme.global.name.value = val ? 'dark' : 'light';
                });

                /* ---- load APIs once ---- */
                onMounted(async () => {
                    try {
                        const cfg = await (await fetch('./configs/default.json')).json();
                        const apiDefs = cfg.apis ?? [];

                        /* fetch one-by-one → keeps order naturally */
                        const ordered = [];
                        for (const { label, url, type = 'table' } of apiDefs) {
                            const rows = await (await fetch(url)).json();
                            ordered.push({ label, type, rows });
                        }

                        datasets.value = ordered;          // sets once, in correct order
                    } catch (e) {
                        console.error('Error loading APIs:', e);
                    }
                });


                return { datasets, isDark };
            },

            /* ---------- Template ---------- */
            template: `
        <v-app>
  
          <!-- Top bar with theme switch -->
          <v-app-bar density="compact" color="primary">
            <v-toolbar-title>Demo Dashboard</v-toolbar-title>
            <v-spacer></v-spacer>
  
            <v-switch
              v-model="isDark"              
              hide-details
              inset
              prepend-icon="mdi-theme-light-dark"
              color="yellow"
              :label="isDark ? 'Dark mode' : 'Light mode'"
            ></v-switch>
          </v-app-bar>
  
          <!-- Main content -->
          <v-main>
            <v-container class="pt-6">
  
              <template v-for="(d, i) in datasets" :key="i">
                <h2 class="text-h5 my-4">{{ d.label }}</h2>
  
                <!-- CARD VIEW -->
                <div v-if="d.type === 'card'">
                  <dynamic-card
                    v-for="(item, idx) in d.rows"
                    :key="idx"
                    :data="item"
                  ></dynamic-card>
                </div>
  
                <!-- TABLE VIEW -->
                <div v-else>
                  <dynamic-table
                    :items="d.rows"
                    :title="d.label"
                  ></dynamic-table>
                </div>
              </template>
  
            </v-container>
          </v-main>
        </v-app>
      `
        };

        createApp(App).use(vuetify).mount('#app');
    </script>

</body>

</html>