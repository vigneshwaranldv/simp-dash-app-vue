<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Dynamic Table (ES-module)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Vuetify CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/vuetify@3.5.0/dist/vuetify.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@mdi/font@7.3.67/css/materialdesignicons.min.css"
      rel="stylesheet"
    />

    <!-- Import-map tells the browser where to find “vue” and “vuetify” -->
    <script type="importmap">
      {
        "imports": {
          "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
          "vuetify": "https://cdn.jsdelivr.net/npm/vuetify@3.5.0/dist/vuetify.esm.js"
        }
      }
    </script>
  </head>

  <body style="margin: 0">
    <div id="app"></div>

    <!-- main script (index.html) -->
    <script type="module">
      import { createApp, ref, onMounted, watch } from "vue";
      import { createVuetify, useTheme } from "vuetify";
      import DynamicTable from "./dynamic-table.js";
      import DynamicCard from "./dynamic-card.js";

      /* ---------- Vuetify instance with light & dark ---------- */
      const vuetify = createVuetify({
        theme: {
          defaultTheme: "dark",
          themes: {
            light: { dark: false },
            dark: { dark: true },
          },
        },
      });

      /* ---------- Root component ---------- */
      const App = {
        components: { DynamicTable, DynamicCard },

        setup() {
          /* datasets that come from the config */
          const datasets = ref([]);
          const loading = ref(false);

          /* ---- dark / light toggle ---- */
          const vTheme = useTheme();
          const isDark = ref(true);

          watch(isDark, (val) => {
            vTheme.global.name.value = val ? "dark" : "light";
          });

          /* ---------- user input + buttons ---------- */
          const userInput = ref("");
          // const handleSubmit = () => {
          //     // TODO: replace with real action (e.g. pass to API call)
          //     console.log('Submitted:', userInput.value.trim());
          // };

          const handleSubmit = async () => {
            if (loading.value) return;
            loading.value = true;
            datasets.value = [];

            try {
              const cfg = await (await fetch("./configs/default.json")).json();
              const ordered = [];

              /* sequential fetch to keep order */
              for (const { label, url, type = "table", apiType = 'GET', payload = {} } of cfg.apis ?? []) {
                /* Optional: incorporate userInput here if your APIs need it
                               e.g. const fullUrl = url + '?q=' + encodeURIComponent(userInput.value.trim());
                            */
                // const rows = await (await fetch(url)).json();
                // ordered.push({ label, type, rows });

                let resp;
                if(apiType.toUpperCase() === 'POST'){
                    resp = await fetch(url,{
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                } else{
                    resp = await fetch(url);
                }

                if(!resp.ok) throw new Error(`${label} -> HTTP ${resp.status}`);

                const rows = await resp.json();
                ordered.push({label, type, rows});
              }
              datasets.value = ordered;
            } catch (err) {
              console.error("Error fetching data:", err);
            } finally {
              loading.value = false;
            }
          };

          const handleClear = () => {
            userInput.value = "";
            datasets.value = [];
          };

          /* ---- load APIs once ---- */
          onMounted(async () => {
            // try {
            //     const cfg = await (await fetch('./configs/default.json')).json();
            //     const apiDefs = cfg.apis ?? [];
            //     /* fetch one-by-one → keeps order naturally */
            //     const ordered = [];
            //     for (const { label, url, type = 'table' } of apiDefs) {
            //         const rows = await (await fetch(url)).json();
            //         ordered.push({ label, type, rows });
            //     }
            //     datasets.value = ordered;          // sets once, in correct order
            // } catch (e) {
            //     console.error('Error loading APIs:', e);
            // }
          });

          return {
            datasets,
            isDark,
            loading,
            userInput,
            handleSubmit,
            handleClear,
          };
        },

        /* ---------- Template ---------- */
        template: `
        <v-app>
  
          <!-- Top bar with theme switch -->
          <v-app-bar density="compact" color="primary">
            <v-toolbar-title>Demo Dashboard</v-toolbar-title>
            <v-spacer></v-spacer>
            
            <v-switch
              v-model="isDark"              
              hide-details
              inset
              prepend-icon="mdi-theme-light-dark"
              color="yellow"
              :label="isDark ? 'Dark mode' : 'Light mode'"
            ></v-switch>
          </v-app-bar>
  
          <!-- Main content -->
          <v-main>
            <v-row class="mb-4" align="center" justify="start">
       <v-col cols="12" sm="4" md="3" lg="2">
         <v-text-field
           v-model="userInput"
           placeholder="Enter something…"
           density="compact"
           hide-details
           clearable
         ></v-text-field>
       </v-col>

       <v-col cols="auto">
         <v-btn
           color="success"
           density="comfortable"
           @click="handleSubmit"
           :disabled = "loading"
           class="mr-sm-2 mb-2 mb-sm-0"
         >Submit</v-btn>
       </v-col>

       <v-col cols="auto">
         <v-btn
           color="error"
           density="comfortable"
           @click="handleClear"
           class="mb-2 mb-sm-0"
         >Clear</v-btn>
       </v-col>
     </v-row>

     <v-progress-linear
  v-if="loading"
  indeterminate
  class="mb-4"
  color="primary"
  height="3"
></v-progress-linear>

            <v-container class="pt-6">
  
              <template v-for="(d, i) in datasets" :key="i">
                <h2 class="text-h5 my-4">{{ d.label }}</h2>
  
                <!-- CARD VIEW -->
                <div v-if="d.type === 'card'">
                  <dynamic-card
                    v-for="(item, idx) in d.rows"
                    :key="idx"
                    :data="item"
                  ></dynamic-card>
                </div>
  
                <!-- TABLE VIEW -->
                <div v-else>
                  <dynamic-table
                    :items="d.rows"
                    :title="d.label"
                  ></dynamic-table>
                </div>
              </template>
  
            </v-container>
          </v-main>
        </v-app>
      `,
      };

      createApp(App).use(vuetify).mount("#app");
    </script>
  </body>
</html>
